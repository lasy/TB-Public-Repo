---
title: "Re-classifying cycles according to BC"
author: "Laura Symul"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  bookdown::html_document2: 
    theme: flatly
    highlight: haddock
    toc: yes
    toc_float: true
    toc_depth: 5
    number_sections: true
    fig_caption: true
---



```{r data_prep_BC_re_class librairies and stuff, include = FALSE, eval = TRUE}
source("Scripts/00_setup.R")
```


```{r data_prep_BC_re_class setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
options(scipen=999)
```


## Re-classifying cycles for Birth Control

### Motivations


The birth-control variable is a user-level variable.
Clue provided one birth-control method per user as the current one (or "on-boarding" one) provided by the user. 

Unfortunately, Clue did not (so far) provided the history of changes of this variable. If a user has changed birth-control, we are not aware of this change. Even if we had this history, users do not always change this variable in their setting.

However, from the tracking behavior and the information logged, we can observe birth control changes for some users.

Therefore, a re-classification of cycles regardin their current birth control method seemed appropriate to be able to compare pill users from non-pill users. This re-classification also allows for the study of symptoms over birth-control transitions.


### Method

In `00_cycle_classification_BC_expl.Rdm`, we have explored the best way to re-classify cycles according to the birth control method (pill vs none/condoms).

We identified input variables that were useful to classify cycles and tested several methods to re-classify these cycles.


The best strategy seems to be

1. train a SVM on the original birth_control labels to obtain probabilities

2. define (and not train) a HMM to add memory in the assignation and use the viterbi algorithm to obtain the most likely BC.

3. define a confidence score for that new assignation that reflect the assymetry in the probability distribution (from 1.)

4. select users and cycles based on that confidence score.


### Loading data

Loading cycles

```{r data_prep_BC_re_class loading cycles}
file.copy(paste0(IO$output_data, "cycles.Rdata"), paste0(IO$tmp_data, "cycles_before_BC_re_classification.Rdata"))
load(paste0(IO$output_data, "cycles.Rdata"), verbose = TRUE)

cycles$birth_control_CLUE = factor(cycles$birth_control_CLUE, levels = c("none / condoms","pill","did not enter"))
cycles$user_id_n = as.numeric(factor(cycles$user_id))

```




### Input variables

```{r data_prep_BC_re_class input variables}
inputs = c("cycle_length","n_days_obs","n_pill","n_prot_sex","n_unprot_sex","diff_cl_median_3c","cl_sd_3c","cycle_nb","period_length","n_egg_white_fluid", "cycle_start")
# ,"score_n_days_obs","score_BC","score_CL"
inputs
```


```{r data_prep_BC_re_class visualization of input variables}
# ,"score_n_days_obs","score_BC","score_CL"
for(input in inputs[-which(inputs == "cycle_start")]){
  eval(parse(text = paste0("cycles$v = cycles$",input)))
  g =  ggplot(cycles, aes(x = v, col = birth_control_CLUE)) + geom_freqpoly(aes(y = ..density..),binwidth = 1) +
    ggtitle(input) +
    scale_color_manual(values = c(cols$BC,"gray")) + 
    xlim(quantile(cycles$v,p = c(0.005,0.955), na.rm = TRUE)+c(-1,1))
  print(g)
}

j = which(colnames(cycles)=="v")
if(length(j)>0){cycles = cycles[,-j]}
```








### Logistic Regression for interpretable significance of the input variables


```{r data_prep_BC_re_class logistic regression}

tic()
eval(parse(text = paste0("
                         glm_fit = glm(birth_control_CLUE ~ ",paste(inputs, collapse = " + "),", 
                         data = cycles[cycles$birth_control_CLUE != 'did not enter',], 
                         family = 'binomial' )")))
toc() # takes about 20 seconds on the full dataset
summary(glm_fit)

```



### Classifying cycles using a SVM


```{r data_prep_BC_re_class svm training subset size}
subset_perc = 5
sample_size = round(subset_perc*nrow(cycles)/100)
sample_size
```

We will only use a subset (`r subset_perc`%) of the data to train the model.

This represents `r sample_size` cycles.

And we only train on cycles of users that indicated `pill`, `none` or `condoms` and exclude users that `did not enter` their birth control in the settings

```{r data_prep_BC_re_class svm training, warning=FALSE}

j = sample( which(cycles$birth_control_CLUE %in% c("pill", "none / condoms")), sample_size)
cycles_training_set = cycles[j , ]

# fit
tic()
eval(parse(text = paste0("svm_fit = parallelSVM(birth_control_CLUE ~ ",paste(inputs, collapse = " + "),", data = cycles_training_set , probability = TRUE)")))
toc()
summary(svm_fit)
```



```{r data_prep_BC_re_class svm predictions, warning=FALSE}

# prediction
cycles$SVM_prob = NA
j = 1:nrow(cycles)
#j = which(cycles$user_id %in% unique(cycles$user_id)[1:1000])

tic()
SVM_prob = predict(svm_fit, newdata = cycles[j,inputs], decision.value = TRUE, probability = TRUE)
toc()
SVM_prob_p = attr(SVM_prob, "probabilities")
head(SVM_prob_p, 20)

cycles$SVM_prob[j] = SVM_prob_p[,which(colnames(SVM_prob_p) == "pill")]

```


```{r data_prep_BC_re_class svm comparisons}

#comparison
table_cont = table(cycles$SVM_prob<0.5, cycles$birth_control_CLUE)

ggplot(cycles, aes(x =SVM_prob, fill = birth_control_CLUE )) + geom_density(alpha = 0.5, bw = 0.01, col = NA) + geom_vline(xintercept = 0.5, linetype = 2)+ xlim(c(0,1))+ scale_fill_manual(values = cols$BC3) + facet_grid(birth_control_CLUE ~ .)

table_cont 
round(t(t(table_cont)/apply(table_cont, 2, sum)), digits = 2)


rm(SVM_prob, table_cont, svm_fit)
```


```{r data_prep_BC_re_class save svm}
save(cycles, file = paste0(IO$tmp_data, "cycles_SVM.Rdata"))
```



```{r data_prep_BC_re_class vizualization with svm, fig.height= 9, fig.width=10}

sub_cycles = cycles[cycles$user_id %in% unique(cycles$user_id)[1:80],]
sub_cycles$user_id_n = factor(sub_cycles$user_id_n, levels = unique(sub_cycles$user_id_n[order(sub_cycles$birth_control_CLUE)]))

g_svm = ggplot(sub_cycles, aes(x = cycle_nb, y = user_id_n, col = SVM_prob)) + geom_point() + facet_grid(birth_control_CLUE ~ ., scale = "free_y")+ scale_color_gradient2(low = cols$NC, high = cols$pill, mid = "gray90", midpoint = 0.5)+theme(legend.position="top")

grid.arrange(g_svm, nrow = 1)

rm(sub_cy,g_svm)

```



### Adding memory with an HMM

![](../Figures Tables Media/Media/cycle_classification_hmm_states_4 states HMM.png)

Model initialisation:


```{r data_prep_BC_re_class hmm: model initialization}
hmm = list()

# defining model
hmm$bc_states = c("none / condoms","pill","X-nc", "X-pill","X-did-not-enter") # we split the state X into 3 sub-states to account for the on-boarding BC info of a given user
hmm$symbols = c(paste0("p_",0:10),"X-nc","X-pill","X-did-not-enter")

#initializing model

bc_emission_prob.N = c(dbeta(seq(0,1,by = 0.1), shape1 = 1 , shape2 = 3)+0.2,0,0,0) # more likely to observe LOW score for N/C
bc_emission_prob.P = c(dbeta(seq(0,1,by = 0.1), shape1 = 3 , shape2 = 1)+0.2,0,0,0) # more likely to observe HIGH score for pill
bc_emission_prob.Xnc = c(rep(0,11),1,0,0) # we only observe Xs when we switch users
bc_emission_prob.Xpill = c(rep(0,11),0,1,0) # we only observe Xs when we switch users
bc_emission_prob.Xdne = c(rep(0,11),0,0,1) # we only observe Xs when we switch users

plot(seq(0,1,by = 0.1) , bc_emission_prob.N[1:11], type = "l", col = cols$NC, lwd = 2)
points(seq(0,1,by = 0.1) , bc_emission_prob.P[1:11], type = "l", col = cols$pill, lwd = 2)


# building and normalizing emission prob matrix
hmm$bc_emission_prob = matrix(c(bc_emission_prob.N,bc_emission_prob.P, bc_emission_prob.Xnc, bc_emission_prob.Xpill,bc_emission_prob.Xdne),nrow = length(hmm$bc_states), ncol = length(hmm$symbols), byrow = TRUE)
hmm$bc_emission_prob = hmm$bc_emission_prob/apply(hmm$bc_emission_prob, 1, sum)

rm(bc_emission_prob.N,bc_emission_prob.P,bc_emission_prob.Xnc, bc_emission_prob.Xpill)


hmm$start_prob_declared = 0.6  #probability to start in the declared BC
hmm$p_stay_in_same = 0.9 # probability to stay in the same BC
hmm$p_exit = 0.01 # probability to switch to one of the X- states
hmm$bc_transition_prob = matrix(
  c( hmm$p_stay_in_same , 1 - hmm$p_stay_in_same- 3*hmm$p_exit , rep(hmm$p_exit,3),
     1 - hmm$p_stay_in_same - 3*hmm$p_exit , hmm$p_stay_in_same, rep(hmm$p_exit,3),
     hmm$start_prob_declared, 1-hmm$start_prob_declared,0,0,0,
     1-hmm$start_prob_declared, hmm$start_prob_declared,0,0,0,
     0.5, 0.5, 0,0,0), 
  nrow = length(hmm$bc_states), ncol = length(hmm$bc_states), byrow = TRUE)

hmm$start_prob = c(hmm$start_prob_declared,1-hmm$start_prob_declared, 0.5)[as.numeric(cycles$birth_control_CLUE[1])]
hmm$start_prob = c(hmm$start_prob, 1 - hmm$start_prob, 0,0,0)

hmm_mod = initHMM(
  States =  hmm$bc_states, Symbols =  hmm$symbols, 
  startProbs =  hmm$start_prob, transProbs =  hmm$bc_transition_prob, 
  emissionProbs =  hmm$bc_emission_prob)

```



Observations:

```{r data_prep_BC_re_class hmm with fit - observations with SVM}
#cy = cy[order(cy$user_id, cy$cycle_nb),]

obs_p =  paste0("p_",round(10*cycles$SVM_prob))

# inserting Xs
x = which(diff(cycles$user_id_n) !=0) 
obs_x = c("X-nc","X-pill","X-did-not-enter")[as.numeric(cycles$birth_control_CLUE)]
id = c(seq_along(obs_p)*10, 10*x+5)
o = order(id)
obs = c(obs_p, obs_x)[o]

rm(x, id, o, obs_p, obs_x)

```

Estimating most likely BC for each cycle using the Viterbi algorithm:

```{r data_prep_BC_re_class viterbi on init model with SVM}
# running viterbi
tic()
vit_init = viterbi(hmm = hmm_mod, obs = obs) 
toc()

vit_init_no_x = vit_init[-grep("X-",vit_init)]
cycles$BC_hmm_init_SVM = vit_init_no_x

rm(vit_init, vit_init_no_x, hmm_mod, obs)
```


```{r data_prep_BC_re_class comparison with the original birth_control values}

table_cont_init_bc = table(cycles$BC_hmm_init_SVM, cycles$birth_control_CLUE)
round(t(t(table_cont_init_bc)/apply(table_cont_init_bc, 2, sum)), digits = 2)

```


```{r data_prep_BC_re_class save cy with HMM }
save(cycles, file = paste0(IO$tmp_data, "cycles_SVM_HMM.Rdata"))
```



```{r data_prep_BC_re_class vizualization of HMM results, fig.height= 9, fig.width=14}


sub_cycles = cycles[cycles$user_id %in% unique(cycles$user_id)[1:80],]
sub_cycles$user_id_n = factor(sub_cycles$user_id_n, levels = unique(sub_cycles$user_id_n[order(sub_cycles$birth_control_CLUE)]))


g_vit_init = ggplot(sub_cycles, aes(x = cycle_nb, y = user_id_n, col = BC_hmm_init_SVM)) + geom_point() + facet_grid(birth_control_CLUE ~ ., scale = "free_y") + theme(legend.position="top")+ scale_color_manual(values = cols$BC)
g_svm = ggplot(sub_cycles, aes(x = cycle_nb, y = user_id_n, col = SVM_prob)) + geom_point() + facet_grid(birth_control_CLUE ~ ., scale = "free_y")+ scale_color_gradient2(low = cols$NC, high = cols$pill, mid = "gray90", midpoint = 0.5)+ theme(legend.position="top")

grid.arrange(g_vit_init, g_svm, nrow = 1)

rm(sub_cy, g_svm, g_vit_init)

```

### Confidence Score

We define a confidence score that accounts for the assymetry in the probability distribution for pill vs N/C cycles.
The confidence score is defined as the cumulative density function of the SVM probabilities for the cycles that stayed in the same BC class.

```{r data_prep_BC_re_class condidence score that reflects the assymetry in the probability distributions}

by = 0.001
h_pill = hist(cycles$SVM_prob[(cycles$birth_control_CLUE == "pill") & (cycles$BC_hmm_init_SVM == "pill")], breaks = seq(0-by/2,1+by/2,by = by), plot = FALSE)
h_nc = hist(1-cycles$SVM_prob[(cycles$birth_control_CLUE != "pill") & (cycles$BC_hmm_init_SVM != "pill")], breaks = seq(0-by/2,1+by/2,by = by), plot = FALSE)

h_pill = data.frame(mids = h_pill$mids, density = h_pill$density, cumsum = cumsum(h_pill$density)/max(cumsum(h_pill$density)))
h_nc = data.frame(mids = h_nc$mids, density = h_nc$density, cumsum = cumsum(h_nc$density)/max(cumsum(h_nc$density)))


confidence_thres = 0.1


g_pill = ggplot(h_pill, aes(x = mids, y = cumsum) )+ 
  geom_line()+ geom_point() + 
  geom_line(aes(y = density/10)) + 
  geom_hline(yintercept = confidence_thres)+
  xlab("SVM prob") + ylab("confidence score")+
  ggtitle("pill confidence score")

g_nc = ggplot(h_nc, aes(x = mids, y = cumsum) )+ 
  geom_line()+ geom_point() + 
  geom_line(aes(y = density/10))+ 
  geom_hline(yintercept = confidence_thres)+
  xlab("SVM prob") + ylab("confidence score")+
  ggtitle("none/condoms confidence score")

grid.arrange(g_pill, g_nc)

cycles$conf = 0
cycles$conf[cycles$BC_hmm_init_SVM == "pill"] = 
  h_pill$cumsum[match(round(cycles$SVM_prob[cycles$BC_hmm_init_SVM == "pill"],digits = 3),round(h_pill$mids, digits = 3))]
cycles$conf[cycles$BC_hmm_init_SVM != "pill"] = 
  h_nc$cumsum[match(round(1-cycles$SVM_prob[cycles$BC_hmm_init_SVM != "pill"],digits = 3),round(h_nc$mids, digits = 3))]


g = ggplot(cycles, aes(x = conf, fill = birth_control_CLUE))
g = g  + geom_histogram(alpha = 0.5, position = "identity", binwidth = 0.05) + 
  facet_grid( BC_hmm_init_SVM ~ . ) + 
  ggtitle("Distribution of cycles confidence score")
g + geom_vline(xintercept = confidence_thres, size = 0.3, linetype = 2)


```


### New BC labels

- we take all users for which the new label is the same as the original label
- for users that have cycles with different labels, we only take users for which all cycles have high enough confidence score for the new labels and for which the average confidence over that sequence of consecutive cycle is high enough as well (twice higher the confidence score for individual cycles).


```{r data_prep_BC_re_class cycle selection}

cycles$BC = NA


# all cycles of a given user has a confidence score that is high enough
conf = (cycles$conf >= confidence_thres)
conf_u = aggregate(conf, by = list(user_id = cycles$user_id), FUN = all)
user_ids_all_cycles_above_threshold = conf_u$user_id[conf_u$x]

# average confidence score per user
conf_av_u = aggregate(cycles$conf, by = list(user_id = cycles$user_id), FUN = mean)
hist(conf_av_u$x, breaks = 100)
user_ids_average_conf_score = conf_av_u$user_id[conf_av_u$x >= 2*confidence_thres]

# keeping the cycles from users that had all their cycles matching the original BC
same = (cycles$birth_control_CLUE == cycles$BC_hmm_init_SVM)
same_u = aggregate(same, by = list(user_id = cycles$user_id), FUN = all)
user_ids_same_label = same_u$user_id[same_u$x]


user_ids = union(intersect(user_ids_all_cycles_above_threshold,user_ids_average_conf_score), user_ids_same_label)
length(user_ids)

cycles$BC[cycles$user_id %in% user_ids] = cycles$BC_hmm_init_SVM[cycles$user_id %in% user_ids]
cycles$BC[is.na(cycles$BC)] = "unclear"

table(cycles$BC)
table(cycles$BC, cycles$birth_control_CLUE)

```



```{r data_prep_BC_re_class save last cy}
save(cycles, file = paste0(IO$tmp_data,"cycles_BC_re_classification_final.Rdata"))
```



```{r data_prep_BC_re_class vizualization of final labels, fig.height= 9, fig.width=14}


sub_cycles = cycles[cycles$user_id %in% unique(cycles$user_id)[1:80],]
sub_cycles$user_id_n = factor(sub_cycles$user_id_n, levels = unique(sub_cycles$user_id_n[order(sub_cycles$birth_control_CLUE)]))


g_vit_init = ggplot(sub_cycles, aes(x = cycle_nb, y = user_id_n, col = BC_hmm_init_SVM)) + geom_point() + facet_grid(birth_control_CLUE ~ ., scale = "free_y") + theme(legend.position="top")+ scale_color_manual(values = cols$BC)
g_svm = ggplot(sub_cycles, aes(x = cycle_nb, y = user_id_n, col = SVM_prob)) + geom_point() + facet_grid(birth_control_CLUE ~ ., scale = "free_y")+ scale_color_gradient2(low = cols$NC, high = cols$pill, mid = "gray90", midpoint = 0.5)+ theme(legend.position="top")

grid.arrange(g_vit_init, g_svm, nrow = 1)

rm(sub_cycles, g_svm, g_vit_init)



sub_cycles = cycles[cycles$user_id %in% unique(cycles$user_id)[1:80],]
sub_cycles$user_id_n = factor(sub_cycles$user_id_n, levels = unique(sub_cycles$user_id_n[order(sub_cycles$birth_control_CLUE)]))
sub_cycles$BC = factor(sub_cycles$BC, levels = c(as.character(par$BC_dict$name),"unclear"))

g_BC = ggplot(sub_cycles, aes(x = cycle_nb, y = user_id_n, col = BC)) + geom_point() + facet_grid(birth_control_CLUE ~ ., scale = "free_y") + theme(legend.position="top")+ scale_color_manual(values = cols$BC3)

g_vit_init = ggplot(sub_cycles, aes(x = cycle_nb, y = user_id_n, col = BC_hmm_init_SVM)) + geom_point() + facet_grid(birth_control_CLUE ~ ., scale = "free_y") + theme(legend.position="top")+ scale_color_manual(values = cols$BC)

g_svm = ggplot(sub_cycles, aes(x = cycle_nb, y = user_id_n, col = SVM_prob)) + geom_point() + facet_grid(birth_control_CLUE ~ ., scale = "free_y")+ scale_color_gradient2(low = cols$NC, high = cols$pill, mid = "gray90", midpoint = 0.5)+ theme(legend.position="top")

g_conf = ggplot(sub_cycles, aes(x = cycle_nb, y = user_id_n, col = conf)) + geom_point() + facet_grid(birth_control_CLUE ~ ., scale = "free_y")+
  scale_color_gradientn(colours = c("red","gray90","black"), 
                         values = rescale(c(0,confidence_thres,1)),
                         limits=c(0,1))+
#scale_color_gradient2(low = "red", high = "black",mid = "gray90", midpoint = confidence_thres, limits = c(0,2*confidence_thres))+
  theme(legend.position="top")

grid.arrange(g_BC, g_vit_init, g_svm, g_conf, nrow = 1)

rm(sub_cycles, g_BC, g_svm, g_vit_init, g_conf)

```



```{r data_prep_BC_re_class vizualization of final labels valid transition, fig.height= 9, fig.width=14}

agg = aggregate(BC ~ user_id_n, cycles[cycles$BC != "unclear",], lu)
sum(agg$BC > 1)

sub_cycles = cycles[cycles$user_id_n %in% agg$user_id_n[which(agg$BC>1)[1:80]],]
sub_cycles$user_id_n = factor(sub_cycles$user_id_n, levels = unique(sub_cycles$user_id_n[order(sub_cycles$birth_control_CLUE)]))
sub_cycles$BC = factor(sub_cycles$BC, levels = c(as.character(par$BC_dict$name),"unclear"))

g_BC = ggplot(sub_cycles, aes(x = cycle_nb, y = user_id_n, col = BC)) + geom_point() + facet_grid(birth_control_CLUE ~ ., scale = "free_y") + theme(legend.position="top")+ scale_color_manual(values = cols$BC3)

g_vit_init = ggplot(sub_cycles, aes(x = cycle_nb, y = user_id_n, col = BC_hmm_init_SVM)) + geom_point() + facet_grid(birth_control_CLUE ~ ., scale = "free_y") + theme(legend.position="top")+ scale_color_manual(values = cols$BC)

g_svm = ggplot(sub_cycles, aes(x = cycle_nb, y = user_id_n, col = SVM_prob)) + geom_point() + facet_grid(birth_control_CLUE ~ ., scale = "free_y")+ scale_color_gradient2(low = cols$NC, high = cols$pill, mid = "gray90", midpoint = 0.5)+ theme(legend.position="top")

g_conf = ggplot(sub_cycles, aes(x = cycle_nb, y = user_id_n, col = conf)) + geom_point() + facet_grid(birth_control_CLUE ~ ., scale = "free_y")+
  scale_color_gradientn(colours = c("red","gray90","black"), 
                         values = rescale(c(0,confidence_thres,1)),
                         limits=c(0,1))+
#scale_color_gradient2(low = "red", high = "black",mid = "gray90", midpoint = confidence_thres, limits = c(0,2*confidence_thres))+
  theme(legend.position="top")

grid.arrange(g_BC, g_vit_init, g_svm, g_conf, nrow = 1)

rm(sub_cycles, g_BC, g_svm, g_vit_init, g_conf)


sub_cycles = cycles[cycles$user_id_n %in% agg$user_id_n[which(agg$BC==1)[1:80]],]
sub_cycles$user_id_n = factor(sub_cycles$user_id_n, levels = unique(sub_cycles$user_id_n[order(sub_cycles$birth_control_CLUE)]))
sub_cycles$BC = factor(sub_cycles$BC, levels = c(as.character(par$BC_dict$name),"unclear"))

g_BC = ggplot(sub_cycles, aes(x = cycle_nb, y = user_id_n, col = BC)) + geom_point() + facet_grid(birth_control_CLUE ~ ., scale = "free_y") + theme(legend.position="top")+ scale_color_manual(values = cols$BC3)

g_vit_init = ggplot(sub_cycles, aes(x = cycle_nb, y = user_id_n, col = BC_hmm_init_SVM)) + geom_point() + facet_grid(birth_control_CLUE ~ ., scale = "free_y") + theme(legend.position="top")+ scale_color_manual(values = cols$BC)

g_svm = ggplot(sub_cycles, aes(x = cycle_nb, y = user_id_n, col = SVM_prob)) + geom_point() + facet_grid(birth_control_CLUE ~ ., scale = "free_y")+ scale_color_gradient2(low = cols$NC, high = cols$pill, mid = "gray90", midpoint = 0.5)+ theme(legend.position="top")

g_conf = ggplot(sub_cycles, aes(x = cycle_nb, y = user_id_n, col = conf)) + geom_point() + facet_grid(birth_control_CLUE ~ ., scale = "free_y")+
  scale_color_gradientn(colours = c("red","gray90","black"), 
                         values = rescale(c(0,confidence_thres,1)),
                         limits=c(0,1))+
#scale_color_gradient2(low = "red", high = "black",mid = "gray90", midpoint = confidence_thres, limits = c(0,2*confidence_thres))+
  theme(legend.position="top")

grid.arrange(g_BC, g_vit_init, g_svm, g_conf, nrow = 1)

rm(sub_cycles, g_BC, g_svm, g_vit_init, g_conf)
rm(agg)

```







```{r data_prep_BC_re_class generating synthetic data, eval = FALSE, include = FALSE}

BC = c("none / condoms","pill","did not enter")
input_to_generate = inputs[- which(inputs %in% c("diff_cl_median_3c","cl_sd_3c", "cycle_start"))]

n_users = 30

s_users = data.frame(
  user_id = sprintf("u%03d", 1:n_users),
  n_cycles = rpois(n_users, 10), 
  birth_control_CLUE = sample(BC,n_users, replace = TRUE))

s_cycles = data.frame(user_id = rep(s_users$user_id, s_users$n_cycles))
s_cycles$cycle_nb = foreach(nc = s_users$n_cycles, .combine = c) %do% {1:nc}
s_cycles$cycle_id = paste0(s_cycles$user_id,"_",s_cycles$cycle_nb)
s_cycles$birth_control_CLUE = s_users$birth_control_CLUE[match(s_cycles$user_id, s_users$user_id)]


# generate "true birth control" 
s_cycles$true_BC = ""

for(u in s_users$user_id){
  transProbs = matrix(c(hmm$p_stay_in_same,1-hmm$p_stay_in_same,1-hmm$p_stay_in_same,hmm$p_stay_in_same),2,2)
  start_prob_nc = c(0.8,0.2,0.6)[as.numeric(factor(s_users$birth_control_CLUE[1],levels = BC))]
  
  hmm_mod_sim = initHMM(
  States =  hmm$bc_states[1:2], Symbols =  seq(0,1,by = 0.1), 
  startProbs =  c(start_prob_nc,1-start_prob_nc), transProbs =  transProbs, 
  emissionProbs =  hmm$bc_emission_prob[1:2,1:11])

  rm(transProbs)  
  
  true_BC = simHMM(hmm_mod_sim, length = s_users$n_cycles[s_users$user_id == u])
  s_cycles$true_BC[s_cycles$user_id == u] = true_BC$states
}

# now generating the input variables

# first empty columns
for(input in input_to_generate){
  eval(parse(text = paste0("s_cycles$",input,"= NA")))
}
s_cycles$true_BC_prob = NA

# then the data
for(i in 1:nrow(s_cycles)){
  s_cycles$true_BC_prob[i] = round(sample(cycles$SVM_prob[cycles$BC == s_cycles$true_BC[i]],1),2)
  j = which((round(cycles$SVM_prob,2) ==  s_cycles$true_BC_prob[i]) & (cycles$BC == s_cycles$true_BC[i]))
  for(input in input_to_generate){
    eval(parse(text = paste0("s_cycles$",input,"[i]= sample(cycles$",input,"[j],1)")))
  }
}




```





```{r data_prep_BC_re_class visualization of generated input variables, eval = FALSE, include = FALSE}

for(input in input_to_generate){
  eval(parse(text = paste0("s_cycles$v = s_cycles$",input)))
  
  g1 =  ggplot(s_cycles, aes(x = v, col = birth_control_CLUE)) + geom_freqpoly(aes(y = ..density..),binwidth = 1) +
    ggtitle(input) +
    scale_color_manual(values = c(cols$BC,"gray")) + 
    xlim(quantile(cycles$v,p = c(0.005,0.955), na.rm = TRUE)+c(-1,1))

  
  g2 =  ggplot(s_cycles, aes(x = v, col = true_BC)) + geom_freqpoly(aes(y = ..density..),binwidth = 1) +
    ggtitle(input) +
    scale_color_manual(values = c(cols$BC,"gray")) + 
    xlim(quantile(cycles$v,p = c(0.005,0.955), na.rm = TRUE)+c(-1,1))
  
  print(grid.arrange(g1,g2))
  
}

j = which(colnames(s_cycles)=="v")
if(length(j)>0){s_cycles = s_cycles[,-j]}
```



```{r data_prep_BC_re_class saving generated input variables, eval = FALSE, include = FALSE}

save(s_cycles, file = paste0(IO$tmp_data, "generated_cycles.Rdata"))

```





