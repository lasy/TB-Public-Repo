---
title: "Adding cluster info on the users table"
author: "Laura Symul"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  bookdown::html_document2: 
    theme: flatly
    highlight: haddock
    toc: yes
    toc_float: true
    toc_depth: 5
    number_sections: true
    fig_caption: true
---



```{r users_descr_avg_dist librairies and stuff, include = FALSE, eval = TRUE}
source("Scripts/00_setup.R")
```


```{r users_descr_avg_dist setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
options(scipen=999)
```



```{r users_descr_avg_dist loading cycles_m and users}
load(paste0(IO$output_data, "users.Rdata"), verbose = TRUE)
```


## Average distance between a user's cycles

We only compute the average distance for users that had as least 1 TB ever logged


```{r users_descr_avg_dist average distance, cache = FALSE}

output_folder = paste0(IO$tmp_data,"avg_dist_per_user/")
dir.create(output_folder)
input_folder = paste0(IO$output_data,"days/")
days_files = list.files(input_folder)
days_files = days_files
N = length(days_files)

registerDoParallel(par$n_cores)
tic()
foreach(n = 1:N)%dopar%{
  output_file = paste0(output_folder, "d_",n,".Rdata")
  if(!file.exists(output_file)){
    load(paste0(input_folder,days_files[n]), verbose = TRUE)
    #impute and transform all cycles to wide format, including cycles without TB logs
    user_ids = unique(days$user_id[days$type == "tender_breasts"])
    days = days[days$user_id %in% user_ids,]
    d = reshape_and_impute(days)
    save(d, file = output_file)
  }
}
toc()
stopImplicitCluster()



source("Scripts/00_functions_distance.R")

registerDoParallel(par$n_cores)
tic()
foreach(n = 1:N)%dopar%{
  output_file = paste0(output_folder,"users_with_avg_distance_",n,".Rdata")
  if(!file.exists(output_file)){
    load(file = paste0(output_folder, "d_",n,".Rdata"), verbose = TRUE)
    # compute average distance
    users_with_avg_distance = foreach(u = unique(d$user_id), .combine = rbind) %do% {
      dist_summary = compute_average_distance(d = d[d$user_id == u,])
      return(data.frame(user_id = u, avg_d = dist_summary$mean, median_d = dist_summary$median, sd_d = dist_summary$sd, file = n))
    }
    save(users_with_avg_distance, file = output_file)
  }
}
toc()
stopImplicitCluster()


registerDoParallel(par$n_cores)
tic()
avg_dist_per_user = foreach(n = 1:N,.combine = rbind)%dopar%{
  load(file = paste0(output_folder,"users_with_avg_distance_",n,".Rdata"), verbose = TRUE)
  return(users_with_avg_distance)
}
toc()
stopImplicitCluster()

save(avg_dist_per_user, file = paste0(IO$tmp_data,"avg_dist_per_user.Rdata"))


```

```{r users_descr_avg_dist test viz, eval = FALSE}

load(file = paste0(output_folder, "d_",n,".Rdata"), verbose = TRUE)

avg_dist_per_user[which(avg_dist_per_user$user_id %in% unique(d$user_id)),]
d = melt(d)
d$cycleday_m_D = as.numeric(gsub("\\.","-",gsub("n\\.","",d$variable)))
d$cycle_nb_m = unlist(strsplit(as.character(d$cycle_id_m), "_"))[(1:nrow(d))*2]
d$tender_breasts = d$value

g = ggplot_imputed_TB(sel_d = d, facet_grid = "user_id", cycle_id = FALSE)
g



```


```{r users_descr_avg_dist saving users, cache = FALSE}

load(file = paste0(IO$tmp_data,"avg_dist_per_user.Rdata"), verbose=  TRUE)
load(paste0(IO$output_data, "users.Rdata"), verbose=  TRUE)


m = match(users$user_id, avg_dist_per_user$user_id)
users$avg_d = avg_dist_per_user$avg_d[m]
users$median_d = avg_dist_per_user$median_d[m]
users$sd_d = avg_dist_per_user$sd_d[m]

save(users, file = paste0(IO$output_data, "users.Rdata"))
file.copy(from = paste0(IO$output_data, "users.Rdata"), to = paste0(IO$tmp_data, "users_with_average_dist.Rdata"), overwrite = TRUE)

```


```{r users_descr_avg_dist dist_viz}


ggplot(users, aes(x = median_d, fill = factor(most_preval_clust))) +
  geom_histogram(position = "identity", col = NA) + 
  facet_grid(most_preval_clust ~ ., scale = "free_y")+
  scale_fill_manual(values = cols$clusters_6)



ggplot(users, aes(x = median_d, fill = factor(most_preval_clust))) +
  geom_density(aes(y = ..density..),alpha = 0.5, position = "identity", col = NA) + 
  facet_grid(most_preval_clust ~ ., scale = "free_y")+
  scale_fill_manual(values = cols$clusters_6)


ggplot(users, aes(x = avg_d, fill = factor(most_preval_clust))) +
  geom_density(aes(y = ..density..),alpha = 0.5, position = "identity", col = NA) + 
  facet_grid(most_preval_clust ~ ., scale = "free_y")+
  scale_fill_manual(values = cols$clusters_6)



ggplot(users, aes(x = sd_d, fill = factor(most_preval_clust))) +
  geom_density(aes(y = ..density..),alpha = 0.5, position = "identity", col = NA) + 
  facet_grid(most_preval_clust ~ ., scale = "free_y")+
  scale_fill_manual(values = cols$clusters_6)

```


