---
title: "Breasts tenderness: data analysis"
author: "Laura Symul"
date: "10/12/2018"
output: 
  bookdown::html_document2: 
    theme: flatly
    highlight: haddock
    toc: yes
    toc_float: true
    toc_depth: 5
    number_sections: true
    fig_caption: true

---



```{r setup knitr, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```

```{r setup my_scripts, include = FALSE, eval = TRUE}
source("Scripts/00_setup.R")
```



```{r child = '_intro_clue.Rmd', cache=TRUE}
```


```{r child = '_data_prep.Rmd', cache=TRUE}
```



```{r child = '_cycle_clustering.Rmd', cache=TRUE}
```



```{r child = '_users_description.Rmd', cache=TRUE}
```






# Birth control: re-classification of cycles based on observations.

The birth-control method is a user-specific variable.
Clue provided one birth-control method per user as the current one (or "on-boarding" one) provided by the user. 

Unfortunately, Clue did not (so far) provided the history of changes of this variable. If a user has changed birth-control, we are not aware of this change. Even if we had this history, users do not always change this variable in their setting.

However, from the tracking behavior and the information logged, we can observe birth control changes for some users.

Therefore, a re-classification of cycles regardin their current birth control method seemed appropriate to be able to compare pill users from non-pill users. This re-classification also allows for the study of symptoms over birth-control transitions.

The file `_cycle_classification_BC.Rmd` provides the code and methods for the re-classification of cycles. 

```{r child = '_cycle_classification_BC.Rmd', cache=TRUE, eval = FALSE}
```

```{r load cy_final that has the final cycle re-classification}
load(file = paste0(IO$tmp_Rdata,"cy_final.Rdata"), verbose = TRUE)
```


```{r add BC to cycles}
m = match(cycles$cycle_id, cy$cycle_id)
cycles$BC = cy$BC[m]
save(cycles, file = paste0(IO$input_data, "cycles.Rdata"))
```

```{r add BC to users}

load(file = paste0(IO$input_data, "users.Rdata"), verbose = TRUE)

user_BC_agg = ddply(cycles, c("user_id"), summarise,
                    BC_rle = paste0(rle(BC)$values, collapse = " - "))

tmp_rle = rle(sort(user_BC_agg$BC_rle))
df = data.frame(categories = tmp_rle$values, n = tmp_rle$lengths)
rm(tmp_rle)
df$categories = factor(df$categories, levels = df$categories[order(df$n)])
ggplot(df, aes(x = categories, y = n)) + geom_bar(stat = "identity") + coord_flip() + geom_text(aes(label = n))
rm(df)

user_BC_agg$BC = user_BC_agg$BC_rle 
user_BC_agg$BC[grep("none / condoms - pill",user_BC_agg$BC_rle)] = "on pill"
user_BC_agg$BC[grep("pill - none / condoms",user_BC_agg$BC_rle)] = "off pill"
user_BC_agg$BC[grep("pill - none / condoms - pill",user_BC_agg$BC_rle)] = "off-on pill"
user_BC_agg$BC[grep("none / condoms - pill - none / condoms",user_BC_agg$BC_rle)] = "on-off pill"
user_BC_agg$BC[nchar(user_BC_agg$BC_rle) > 38 ] = "mult. trans."

m = match(users$user_id, user_BC_agg$user_id)
users$BC = user_BC_agg$BC

table(users$BC,users$birth_control)
rm(m,user_BC_agg)

save(users, file = paste0(IO$input_data, "users.Rdata"))
```



```{r add BC to days}

output_folder = paste0(IO$input_data,"days/")
days_files = list.files(output_folder)

# copy old content in a new folder
copy_folder = paste0(IO$input_data, "days_without_BC")
dir.create(copy_folder)
file.copy(from = paste0(output_folder,days_files), to = copy_folder)

# actually add BC to days
registerDoParallel(par$n_cores)
tic()
foreach(file = days_files) %dopar%{
  cat(file,"\n")
  file_path = paste0(output_folder,file)
  load(file_path, verbose = TRUE)
  days$BC = cycles$BC[match(days$cycle_id, cycles$cycle_id)]
  save(days, file = file_path)
}
toc()
stopImplicitCluster()



```



# Demographics


```{r age and bmi cat}

users$age_cat = cut(users$age, breaks = breaks$age)
users$bmi = users$weight / (users$height/100)^2
users$bmi_cat = cut(users$bmi, breaks = breaks$bmi)


cycles$age_cat = cut(cycles$age, breaks = breaks$age)
cycles$bmi = cycles$weight / (cycles$height/100)^2
cycles$bmi_cat = cut(cycles$bmi, breaks = breaks$bmi)
```




```{r number of users in each considered category}

g = ggplot(users, aes(x = age, fill = birth_control))
g + geom_histogram(binwidth = 1) + facet_grid(birth_control ~.)

g = ggplot(users, aes(x = age, fill = country))
g + geom_histogram(binwidth = 1) + facet_wrap(country ~.)


agg = aggregate(user_id ~ age_cat + bmi_cat + birth_control, users, length)
#agg = agg[(agg$bmi_cat != "(0,15]") & (agg$age_cat != "(10,15]") & (agg$age_cat != "(40,45]"),]
g = ggplot(agg, aes(y = birth_control, x= 0,   col = birth_control)) + 
  facet_grid(bmi_cat ~ age_cat) + 
  #geom_point(aes(size = user_id), alpha = 0.3) +
  geom_text(aes(label = user_id)) + 
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.ticks = element_blank(),axis.text.x = element_blank()) + 
  guides(color = FALSE, size = FALSE) + xlab("") + ylab("") + ggtitle("Number of users per category of age (horizontal) and bmi (vertical)")

g

ggsave(filename = paste0(IO$panels, "S1_X_number_of_users_per_cat.pdf"), plot = g)

agg_users = agg

agg = aggregate(cycle_id ~ age_cat + bmi_cat + birth_control, cycles, length)
#agg = agg[(agg$bmi_cat != "(0,15]") & (agg$age_cat != "(10,15]") & (agg$age_cat != "(40,45]"),]

g = ggplot(agg, aes(y = birth_control, x= 0,   col = birth_control)) + 
  facet_grid(bmi_cat ~ age_cat) + 
  #geom_point(aes(size = cycle_id), alpha = 0.3) +
  geom_text(aes(label = cycle_id)) + 
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.ticks = element_blank(),axis.text.x = element_blank()) + 
  guides(color = FALSE, size = FALSE) + xlab("") + ylab("") + ggtitle("Number of cycles per category of age (horizontal) and bmi (vertical)")
g

ggsave(filename = paste0(IO$panels, "S1_X_number_of_cycles_per_cat.pdf"), plot = g)



agg = merge(agg, agg_users)


rm(agg_users, agg, g)

```



```{r child = '_tracking_behavior.Rmd', cache=TRUE}
```




```{r child = '_overall_profile.Rmd', cache=TRUE}
```



```{r child = '_cycle_clustering_vanilla.Rmd', cache=TRUE}
```



```{r child = '_cycle_clustering_enough_logs.Rmd', cache=TRUE}
```


```{r child = '_cycle_clustering_cat_data.Rmd', cache=TRUE}
```



```{r child = '_cycle_clustering_cat_data_jaccard.Rmd', cache=TRUE}
```



```{r child = '_imputing_missing_data_and_new_jaccard_like_distance.Rmd', cache=TRUE}
```



```{r child = '_cycle_clustering_imputed_custom_jaccard_clara.Rmd', cache=TRUE}
```




```{r child = '_user_clustering.Rmd', cache=TRUE}
```



```{r child = '_pill_perturbation_analysis.Rmd', cache=TRUE}
```

 
# TO DO

* Cluster prediction: use other prediction methods (SVM?!?)




# FURTHER WORK


* infering missing data points

* Look at the co-occurence of other symptoms (cramps, headaches, etc.)

* or cluster everything together (but how do I interepret categories?)

* Define some pain profiles (e.g. only cramps vs combined symptoms; pre-menstrual vs menstrual; consecutive days vs interrupted logging)

* instead of making plots from 1st day of menstruation > do it from the 1st heaviest day of menstruation ( I tried a little bit, does not look so interesting)













