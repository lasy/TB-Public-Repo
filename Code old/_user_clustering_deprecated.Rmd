---
title: "User Clustering"
author: "Laura Symul"
date: "12/7/2018"
output: html_document
---


## USERS CLUSTERING

### Selecting users with at least 1 logged tender breasts

The days file is the same as for the clustering at the cycle level.
We will only have later to divide by the total number of cycle a user has ever logged (-1).

```{r user_clustering loading days for user clustering}
load(file = paste0(IO$Rdata,"days_TB_only.Rdata"), verbose = TRUE)
```


### Formatting days for clustering - normalizing by the max per user


```{r user_clustering preparing u for user clustering}
k = which(!is.na(days$cycleday_m_D))
d = days[k,]
rm(k)
d$tender_breasts = 1

u = aggregate(tender_breasts ~ user_id + cycleday_m_D, d, sum)
u$n_cycles = users$n_cycle[match(u$user_id, users$user_id)] - 1
u$perc_tender_breasts = u$tender_breasts/u$n_cycles


agg = aggregate(tender_breasts ~ user_id, u, max)
colnames(agg) = c("user_id","max_tender_breasts")
u = merge(u, agg, all = TRUE)
rm(agg)
u$rel_tender_breasts = u$tender_breasts/u$max_tender_breasts


agg = aggregate(cycle_id_m ~ user_id, d, lu)
colnames(agg) = c("user_id","n_cycles_with_TB")
u = merge(u, agg, all = TRUE)
rm(agg)
u$per_c_tender_breasts = u$tender_breasts/u$n_cycles_with_TB

```



### Ideal number of clusters ? 

#### with perc_tender_breasts

```{r user_clustering u_wide with perc_tender_breasts}

u_wide = reshape(u[,c("user_id","cycleday_m_D","perc_tender_breasts")],
                        idvar = "user_id",timevar = "cycleday_m_D",
                        direction = "wide")
u_wide[is.na(u_wide)] = 0

# re-order the columns by cycleday_m_D
o = order(as.numeric(sapply(strsplit(colnames(u_wide)[2:ncol(u_wide)],"\\."), "[[", 2)))
if(any(diff(o)!=1)){u_wide = data.frame(user_id = u_wide$user_id, u_wide[,o+1] )}
rm(o)

head(u_wide)
```


```{r user_clustering user clusters - exploring number of clusters with perc_tender_breasts}

user_ids = u_wide$user_id
WSS_k_tot.withinss = c()
n_centers = 2:7
tic()
for(n_center in n_centers){
  cat(n_center,"\n")
  kmeans_type = kmeans(u_wide[,-1], centers = n_center, nstart = 20)
  if(n_center == 2){WSS_k_tot.withinss = c(kmeans_type$totss, kmeans_type$tot.withinss) }
  else{ WSS_k_tot.withinss = c(WSS_k_tot.withinss, kmeans_type$tot.withinss )}
  
  u$kmean_group = kmeans_type$cluster[match(u$user_id, u_wide$user_id)]
  
  u = u[order(u$kmean_group),]
  u$user_id_factors_kmeans = factor(u$user_id, levels = unique(u$user_id))
  
  #### plots
  # first showing some examples
  set.seed(6)
  u_subset = u[u$user_id %in% user_ids[sample(1:length(user_ids),20)],]
  # black dots
  print(ggplot(u_subset, aes(x = cycleday_m_D, y = perc_tender_breasts)) + geom_area() + facet_grid(user_id ~.) )
  # colored dots
  print(ggplot(u_subset, aes(x = cycleday_m_D, y = perc_tender_breasts, fill = factor(kmean_group))) + geom_area()+ facet_grid(user_id ~.)+ guides(col = FALSE))
  # ordered colored dots
  u_subset = u_subset[order(u_subset$kmean_group),]
  u_subset$user_id = factor(u_subset$user_id, levels = unique(u_subset$user_id))
  print(ggplot(u_subset, aes(x = cycleday_m_D, y = perc_tender_breasts, fill = factor(kmean_group))) + geom_area()+ facet_grid(user_id ~.)+ guides(col = FALSE))
  
  # then showing the profiles for the clusters
  agg = aggregate(tender_breasts ~ cycleday_m_D  + kmean_group , u,  sum)
  agg2 = aggregate(n_cycles ~ user_id + kmean_group, u, max)
  agg3 = aggregate(n_cycles ~ kmean_group, agg2, sum)
  agg = merge(agg, agg3, all = TRUE)
  
  agg$perc_tender_breasts = agg$tender_breasts/agg$n_cycles
  print(ggplot(agg, aes(x = cycleday_m_D, y =tender_breasts, col = factor(kmean_group))) + geom_line() + facet_grid(kmean_group ~.))
  print(ggplot(agg, aes(x = cycleday_m_D, y =perc_tender_breasts, col = factor(kmean_group))) + geom_line() )
  print(ggplot(agg3, aes(x = kmean_group, y =n_cycles, fill = factor(kmean_group))) + geom_bar(stat = "identity") )

  rm(agg2, agg3)
}
toc()
df = data.frame(n_clust = c(1,n_centers), WSS = WSS_k_tot.withinss)
ggplot(df, aes(x =n_clust, y = WSS)) + geom_bar(stat = "identity", fill = "steelblue2")

rm(df,user_ids, kmeans_type, u_subset, agg, n_center, n_centers, WSS_k_tot.withinss)
```



#### with per_c_tender_breasts

```{r user_clustering u_wide with per_c_tender_breasts}

u_wide = reshape(u[,c("user_id","cycleday_m_D","per_c_tender_breasts")],
                        idvar = "user_id",timevar = "cycleday_m_D",
                        direction = "wide")
u_wide[is.na(u_wide)] = 0

# re-order the columns by cycleday_m_D
o = order(as.numeric(sapply(strsplit(colnames(u_wide)[2:ncol(u_wide)],"\\."), "[[", 2)))
if(any(diff(o)!=1)){u_wide = data.frame(user_id = u_wide$user_id, u_wide[,o+1] )}
rm(o)


head(u_wide)
```


```{r user_clustering user clusters - exploring number of clusters with per_c_tender_breasts}

user_ids = u_wide$user_id
WSS_k_tot.withinss = c()
n_centers = 2:7
tic()
for(n_center in n_centers){
  cat(n_center,"\n")
  kmeans_type = kmeans(u_wide[,-1], centers = n_center, nstart = 20)
  if(n_center == 2){WSS_k_tot.withinss = c(kmeans_type$totss, kmeans_type$tot.withinss) }
  else{ WSS_k_tot.withinss = c(WSS_k_tot.withinss, kmeans_type$tot.withinss )}
  
  u$kmean_group = kmeans_type$cluster[match(u$user_id, u_wide$user_id)]
  
  u = u[order(u$kmean_group),]
  u$user_id_factors_kmeans = factor(u$user_id, levels = unique(u$user_id))
  
  #### plots
  # first showing some examples
  set.seed(6)
  u_subset = u[u$user_id %in% user_ids[sample(1:length(user_ids),20)],]
  # black dots
  print(ggplot(u_subset, aes(x = cycleday_m_D, y = perc_tender_breasts)) + geom_area() + facet_grid(user_id ~.) )
  # colored dots
  print(ggplot(u_subset, aes(x = cycleday_m_D, y = perc_tender_breasts, fill = factor(kmean_group))) + geom_area()+ facet_grid(user_id ~.)+ guides(col = FALSE))
  # ordered colored dots
  u_subset = u_subset[order(u_subset$kmean_group),]
  u_subset$user_id = factor(u_subset$user_id, levels = unique(u_subset$user_id))
  print(ggplot(u_subset, aes(x = cycleday_m_D, y = perc_tender_breasts, fill = factor(kmean_group))) + geom_area()+ facet_grid(user_id ~.)+ guides(col = FALSE))
  
  # then showing the profiles for the clusters
  agg = aggregate(tender_breasts ~ cycleday_m_D  + kmean_group , u,  sum)
  agg2 = aggregate(n_cycles ~ user_id + kmean_group, u, max)
  agg3 = aggregate(n_cycles ~ kmean_group, agg2, sum)
  agg = merge(agg, agg3, all = TRUE)
  
  agg$perc_tender_breasts = agg$tender_breasts/agg$n_cycles
  print(ggplot(agg, aes(x = cycleday_m_D, y =tender_breasts, col = factor(kmean_group))) + geom_line() + facet_grid(kmean_group ~.))
  print(ggplot(agg, aes(x = cycleday_m_D, y =perc_tender_breasts, col = factor(kmean_group))) + geom_line() )
  print(ggplot(agg3, aes(x = kmean_group, y =n_cycles, fill = factor(kmean_group))) + geom_bar(stat = "identity") )

  rm(agg2, agg3)
}
toc()
df = data.frame(n_clust = c(1,n_centers), WSS = WSS_k_tot.withinss)
ggplot(df, aes(x =n_clust, y = WSS)) + geom_bar(stat = "identity", fill = "steelblue2")

rm(df,user_ids, kmeans_type, u_subset, agg, n_center, n_centers, WSS_k_tot.withinss)
```



#### with rel_tender_breasts

```{r user_clustering u_wide with rel_tender_breasts}

u_wide = reshape(u[,c("user_id","cycleday_m_D","rel_tender_breasts")],
                        idvar = "user_id",timevar = "cycleday_m_D",
                        direction = "wide")
u_wide[is.na(u_wide)] = 0

# re-order the columns by cycleday_m_D
o = order(as.numeric(sapply(strsplit(colnames(u_wide)[2:ncol(u_wide)],"\\."), "[[", 2)))
if(any(diff(o)!=1)){u_wide = data.frame(user_id = u_wide$user_id, u_wide[,o+1] )}
rm(o)

head(u_wide)

head_u_wide = u_wide[1:15,]

colnames(head_u_wide) = gsub("rel_tender_breasts..","-",colnames(head_u_wide), fixed = TRUE)
colnames(head_u_wide) = gsub("rel_tender_breasts.","",colnames(head_u_wide), fixed = TRUE)
head_u_wide[,2:ncol(head_u_wide)] = round(head_u_wide[,2:ncol(head_u_wide)], digits = 2)
head_u_wide
write.table(head_u_wide, file = "data/example_day_values_for_user_clustering.txt", col.names = TRUE, row.names = FALSE, sep = "\t",quote = FALSE)

```


```{r user_clustering user clusters - exploring number of clusters with rel_tender_breasts}

user_ids = u_wide$user_id
WSS_k_tot.withinss = c()
n_centers = 2:7
tic()
for(n_center in n_centers){
  cat(n_center,"\n")
  kmeans_type = kmeans(u_wide[,-1], centers = n_center, nstart = 20)
  if(n_center == 2){WSS_k_tot.withinss = c(kmeans_type$totss, kmeans_type$tot.withinss) }
  else{ WSS_k_tot.withinss = c(WSS_k_tot.withinss, kmeans_type$tot.withinss )}
  
  u$kmean_group = kmeans_type$cluster[match(u$user_id, u_wide$user_id)]
  
  u = u[order(u$kmean_group),]
  u$user_id_factors_kmeans = factor(u$user_id, levels = unique(u$user_id))
  
  #### plots
  # first showing some examples
  set.seed(6)
  u_subset = u[u$user_id %in% user_ids[sample(1:length(user_ids),20)],]
  # black dots
  print(ggplot(u_subset, aes(x = cycleday_m_D, y = perc_tender_breasts)) + geom_area() + facet_grid(user_id ~.) )
  # colored dots
  print(ggplot(u_subset, aes(x = cycleday_m_D, y = perc_tender_breasts, fill = factor(kmean_group))) + geom_area()+ facet_grid(user_id ~.)+ guides(col = FALSE))
  # ordered colored dots
  u_subset = u_subset[order(u_subset$kmean_group),]
  u_subset$user_id = factor(u_subset$user_id, levels = unique(u_subset$user_id))
  print(ggplot(u_subset, aes(x = cycleday_m_D, y = perc_tender_breasts, fill = factor(kmean_group))) + geom_area()+ facet_grid(user_id ~.)+ guides(col = FALSE))
  
  # then showing the profiles for the clusters
  agg = aggregate(tender_breasts ~ cycleday_m_D  + kmean_group , u,  sum)
  agg2 = aggregate(n_cycles ~ user_id + kmean_group, u, max)
  agg3 = aggregate(n_cycles ~ kmean_group, agg2, sum)
  agg = merge(agg, agg3, all = TRUE)
  
  agg$perc_tender_breasts = agg$tender_breasts/agg$n_cycles
  print(ggplot(agg, aes(x = cycleday_m_D, y =tender_breasts, col = factor(kmean_group))) + geom_line() + facet_grid(kmean_group ~.))
  print(ggplot(agg, aes(x = cycleday_m_D, y =perc_tender_breasts, col = factor(kmean_group))) + geom_line() )
  print(ggplot(agg3, aes(x = kmean_group, y =n_cycles, fill = factor(kmean_group))) + geom_bar(stat = "identity") )

  rm(agg2, agg3)
}
toc()
df = data.frame(n_clust = c(1,n_centers), WSS = WSS_k_tot.withinss)
ggplot(df, aes(x =n_clust, y = WSS)) + geom_bar(stat = "identity", fill = "steelblue2")

rm(df,user_ids, kmeans_type, u_subset, agg, n_center, n_centers, WSS_k_tot.withinss)
```


In the 3 cases, we see that the "elbow" is around n_clust = 2.
BUT the type of clusters is very different in the 3 cases (the 3 ways of "normalizing" the user TB profiles):

- u$perc_tender_breasts, =n_tender_breast / ALL their recorded cycles (including those without TB).

In this case, the clusters reflect more the intensity (or frequency) of logged TB than the temporal dynamic.

- u$rel_tender_breasts, =n_tender_breast / max(n_tender_breast) >> always peaks to 1 somewhere

In this case, the clusters reflect different menstrual phases at which TB are logged. It captures better the timing, not the intensity.
Especially, the 2 clusters are the most different and show the most this difference between pre-menstrual and menstrual.

- u$per_c_tender_breasts

Somewhere in between the 2.


Using rel_tender_breasts seems to be more interesting as it captures different dynamics. We can then use perc_tender_breasts to reflect the intensity.


### 2 clusters

```{r user_clustering user clusters - 2 clusters}
n_center = 2
kmeans_type = kmeans(u_wide[,-1], centers = n_center, nstart = 20)

u$kmean_group_num = kmeans_type$cluster[match(u$user_id, u_wide$user_id)]

agg_clust = aggregate(tender_breasts ~ cycleday_m_D + kmean_group_num, u, sum)
# percentage of reported symptoms: sum of TB vs nb of cycles
agg2 =  aggregate(n_cycles ~ user_id + kmean_group_num, u, max)
agg = aggregate(n_cycles ~ kmean_group_num, agg2, sum)
colnames(agg) = c("kmean_group_num","n_cycles"); rm(agg2)
agg_clust = merge(agg_clust, agg, all = TRUE)
agg_clust$perc_tender_breasts = agg_clust$tender_breasts/agg_clust$n_cycles

# renaming the clusters as "menstrual" and "pre-menstrual"
agg = aggregate(perc_tender_breasts ~ kmean_group_num, agg_clust, max)
agg_clust$max_perc_tender_breasts = agg$perc_tender_breasts[match(agg_clust$kmean_group_num, agg$kmean_group_num)]
agg = agg_clust[agg_clust$perc_tender_breasts == agg_clust$max_perc_tender_breasts,]
agg$kmean_group = c("pre-menstrual","menstrual")[(agg$cycleday_m_D == 0)+1]
agg$kmean_group = factor(agg$kmean_group, levels = c("menstrual","pre-menstrual"))
agg_clust$kmean_group = agg$kmean_group[match(agg_clust$kmean_group_num, agg$kmean_group_num)]
c.dict  = agg[,c("kmean_group_num","kmean_group")]

u$kmean_group = agg$kmean_group[match(u$kmean_group_num, agg$kmean_group_num)]
u = u[order(u$kmean_group_num),]
u$user_id_m_factors_kmeans = factor(u$user_id, levels = unique(u$user_id))

#### plots
# first showing some examples
set.seed(6)
user_ids = u_wide$user_id
u_subset = u[u$user_id %in% user_ids[sample(1:length(user_ids),20)],]
# black dots
print(ggplot(u_subset, aes(x = cycleday_m_D, y = perc_tender_breasts)) + geom_area() + facet_grid(user_id ~.) )
# colored dots
print(ggplot(u_subset, aes(x = cycleday_m_D, y = perc_tender_breasts, fill = kmean_group)) + geom_area()+ facet_grid(user_id ~.)+ scale_fill_manual(values = cols$clusters)+ guides(col = FALSE))
# ordered colored dots
u_subset = u_subset[order(u_subset$kmean_group),]
u_subset$user_id = factor(u_subset$user_id, levels = unique(u_subset$user_id))
print(ggplot(u_subset, aes(x = cycleday_m_D, y = perc_tender_breasts, fill = kmean_group)) + geom_area()+ facet_grid(user_id ~.)+ scale_fill_manual(values = cols$clusters)+ guides(col = FALSE))

# then showing the profiles for the clusters
print(ggplot(agg_clust, aes(x = cycleday_m_D, y =tender_breasts, col = kmean_group)) + geom_line() + scale_color_manual(values = cols$clusters)+ facet_grid(kmean_group ~.))
print(ggplot(agg_clust, aes(x = cycleday_m_D, y =perc_tender_breasts, col = kmean_group)) + geom_line() + scale_color_manual(values = cols$clusters))
print(ggplot(agg, aes(x = kmean_group, y =n_cycles, fill = factor(kmean_group))) + geom_bar(stat = "identity")+ scale_fill_manual(values = cols$clusters) )

rm(user_ids, u_subset)
```



```{r user_clustering user clusters - figure 2D}

g = ggplot(agg_clust, aes(x = cycleday_m_D, y =perc_tender_breasts, col = kmean_group))+ 
  geom_vline(xintercept = 0, col = "gray90", size = 1.5) + 
  geom_point(size = 0.6)+geom_line(linetype = 3) +
  scale_y_continuous(labels = scales::percent)+ scale_x_continuous(breaks = par$x.axis)+
  scale_color_manual(values = cols$clusters)+
  xlab("cycleday from 1st day of menstruation") + ylab("n tender breasts / n cycles")+
  guides(color = FALSE)

g

ggsave(filename = paste0(IO$panels, "2D_user_clusters.pdf"), plot = g, width = viz$full_width/9*2, height = viz$full_width/5)



agg_c = aggregate(n_cycles ~ kmean_group, agg_clust, min)
agg_c$perc_cycles = agg_c$n_cycles/sum(agg_c$n_cycles)
agg_c$kmean_group_short = c("M","Pre-M")[(agg_c$kmean_group == "pre-menstrual")+1]
agg_c

agg_u = aggregate(user_id ~ kmean_group, u, lu)
agg_u$perc_users = agg_u$user_id/sum(agg_u$user_id)
agg_u$kmean_group_short = c("M","Pre-M")[(agg_u$kmean_group == "pre-menstrual")+1]
agg_u


g = ggplot(agg_u, aes(x = kmean_group_short, y =perc_users, fill = kmean_group)) + 
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = scales::percent, position = "right")+ 
  xlab("") + ylab("")+ ggtitle("% users")+
  scale_fill_manual(values = cols$clusters)+
  guides(fill = FALSE)+ theme(plot.title = element_text(size=10))
g
ggsave(filename = paste0(IO$panels, "2D_n_users_in_clusters.pdf"), plot = g, width = viz$full_width/9, height = viz$full_width/5)

rm(g,  agg, agg_clust, agg_c, agg_u)


```



```{r user_clustering user cluster - reporting on users table}
users$kmean_group = u$kmean_group[match(users$user_id, u$user_id)]
```



#### Intensity

```{r user_clustering user cluster - intensity}
agg = aggregate(perc_tender_breasts ~user_id, u, max)
colnames(agg) = c("user_id","TB_intensity")

users = merge(users, agg, all = TRUE)
rm(agg)
```

#### Distance

```{r user_clustering user cluster - distance}
# cluster centers
c_M = as.vector(kmeans_type$centers[c.dict$kmean_group == "menstrual",])
c_preM = as.vector(kmeans_type$centers[c.dict$kmean_group == "pre-menstrual",])


cor_M = apply(u_wide[,-1], 1, cor, c_M)
cor_preM = apply(u_wide[,-1], 1, cor, c_preM)
m = match(users$user_id, u_wide$user_id)
users$cor_M = cor_M[m]
users$cor_preM = cor_preM[m]
users$dist_u_clusters = 1-apply(users[,c("cor_M","cor_preM")], 1, max)

rm(m, cor_M, cor_preM, kmeans_type)
```



### Examples


```{r user_clustering user clusters examples - figure 2E}
users$TB_intensity_r = round(users$TB_intensity, digits = 1)
users$user_cluster = as.character(users$kmean_group)
users$user_cluster[users$dist_u_clusters > 0.8] = "undefined"
users$user_cluster[(users$dist_u_clusters < 0.8) & (users$cor_preM > 0.7) & (users$cor_M > 0.7)] = "mixed"
users$user_cluster = factor(users$user_cluster, levels = c("menstrual","pre-menstrual","mixed","undefined"))

u$user_cluster = users$user_cluster[match(u$user_id, users$user_id)]

### selecting 6 users: 2 for M (low and high intensity), 2 for pre-M (low and high intensity), 1 in between M and pre-M, 1 completely outside these 2.
x = 2
# pre-menstrual strong
u1 = which((users$kmean_group == "pre-menstrual") & (users$TB_intensity_r == 1  ) & (users$dist_u_clusters < 0.1) & (users$cor_preM > 0.9) & (users$cor_M < 0.6))[2]
# pre-menstrual mild
u2 = which((users$kmean_group == "pre-menstrual") & (users$TB_intensity_r == 0.3) & (users$dist_u_clusters < 0.1) & (users$cor_preM > 0.9) & (users$cor_M < 0.6))[2]
# in between
u3 = which((users$kmean_group == "pre-menstrual") & (users$TB_intensity_r == 0.6) & (users$dist_u_clusters < 0.5) & (users$cor_preM > 0.7) & (users$cor_M > 0.7))[2]
# menstrual mild
u4 = which((users$kmean_group == "menstrual"    ) & (users$TB_intensity_r == 0.3) & (users$dist_u_clusters < 0.1) & (users$cor_preM < 0.6) & (users$cor_M > 0.9))[1]
# menstrual strong
u5 = which((users$kmean_group == "menstrual"    ) & (users$TB_intensity_r == 1  ) & (users$dist_u_clusters < 0.1) & (users$cor_preM < 0.6) & (users$cor_M > 0.9))[2]
# nor pre-menstrual or menstrual
u6 = which((users$kmean_group == "menstrual"    ) & (users$TB_intensity_r == 0.5) & (users$dist_u_clusters > 0.8) & (users$cor_preM < 0.6) & (users$cor_M < 0.6))[c(1,3)]
ui = c(u1,u2,u3,u4,u5,u6)
user_ids = users$user_id[ui]

k = which(u$user_id %in% user_ids)
u_subset = u[k,]
u_subset$user_id = factor(u_subset$user_id, levels = user_ids)
g = ggplot(u_subset, aes(x = cycleday_m_D, y = perc_tender_breasts, fill = user_cluster)) + 
  geom_vline(xintercept = 0, col = "gray90", size = 1.5) + 
  geom_area()+ facet_grid(user_id ~.) + 
  scale_y_continuous(breaks = NULL, minor_breaks = seq(0,1,by = 1/2), limits = c(0,1))+ scale_x_continuous(breaks = par$x.axis)+
  scale_fill_manual(values = cols$clusters_4)+
  xlab("cycleday from 1st day of menstruation") + ylab("n tender breasts / n cycles")+
  guides(fill = FALSE)+ 
  theme(
    strip.background = element_blank(),
    strip.text.y = element_blank()
  )
print(g)

ggsave(filename = paste0(IO$panels, "2E_user_clusters_examples.pdf"), plot = g, width = viz$full_width/15*3.5, height = viz$full_width/4.75)


users_subset = users[ui,]
users_subset$user_id = factor(users_subset$user_id, levels = rev(user_ids))
g = ggplot(users_subset, aes(y = TB_intensity,x = user_id, fill = user_cluster))+
  geom_bar(stat = "identity", width = 0.7) + coord_flip()+
  guides(fill = FALSE)+ xlab("")+ylab("intensity")+
  scale_y_continuous(breaks = c(0,1), minor_breaks = seq(0,1,by = 1/2), limits = c(0,1))+
  scale_x_discrete(labels = NULL, expand = c(0,0))+
  scale_fill_manual(values = cols$clusters_4)+
  theme(
    strip.background = element_blank(),
    strip.text.y = element_blank()
  )
g

ggsave(filename = paste0(IO$panels, "2E_user_clusters_examples_intensity.pdf"), plot = g, width = viz$full_width/15, height = viz$full_width/4.75)


g = ggplot(users_subset, aes(y = dist_u_clusters,x = user_id, fill = user_cluster))+
  geom_bar(stat = "identity", width = 0.7) + coord_flip()+
  guides(fill = FALSE)+ xlab("")+ylab("distance")+
  scale_y_continuous(breaks = c(0,1), minor_breaks = seq(0,1.5,by = 1/2), limits = c(0,1.2))+
  scale_x_discrete(labels = NULL, expand = c(0,0))+
  scale_fill_manual(values = cols$clusters_4)+
  theme(
    strip.background = element_blank(),
    strip.text.y = element_blank()
  )
g

ggsave(filename = paste0(IO$panels, "2E_user_clusters_examples_distance.pdf"), plot = g, width = viz$full_width/15, height = viz$full_width/4.75)


rm(u1, u2, u3, u4, u5, u6, ui)
rm(user_ids, users_subset)
rm(x,k)
rm(g)

# for(i in 1:6){
#   eval(parse(text = paste0("ui = u",i)))
#   k = which(u$user_id %in% users$user_id[ui])
#   u_subset = u[k,]
#   g = ggplot(u_subset, aes(x = cycleday_m_D, y = perc_tender_breasts, fill = factor(kmean_group))) +
#     geom_vline(xintercept = 0, col = "gray90", size = 1.5) + 
#     geom_area()+ facet_grid(user_id ~.) + 
#     ylim(c(0,1))+ scale_x_continuous(breaks = par$x.axis)+
#     guides(col = FALSE)
#   print(g)
# }

```


```{r user_clustering distance and intensity - FIGURE 2F}

g = ggplot(users, aes(x = TB_intensity, fill = kmean_group))+ 
  geom_density(col = NA, alpha = 0.5, bw = 0.02) + 
  scale_fill_manual(values = cols$clusters)+
  guides(fill = FALSE)+
  xlab("intensity of reported\ntender breasts per user")
g


ggsave(filename = paste0(IO$panels, "2F_user_clusters_intensity.pdf"), plot = g, width = viz$full_width/6, height = viz$full_width/5)



g = ggplot(users, aes(x = dist_u_clusters, fill = kmean_group))+ 
  geom_density(col = NA, alpha = 0.5, bw = 0.03) + 
  scale_fill_manual(values = cols$clusters)+
  guides(fill = FALSE)+
  xlab("max. distance\nto cluster centroids")
g

ggsave(filename = paste0(IO$panels, "2F_user_clusters_distance.pdf"), plot = g, width = viz$full_width/6, height = viz$full_width/5)

rm(g)
```





### Clusters by age and birth control - user clusters


```{r user_clustering user clusters by age and birth control - user clusters}
m = match(u$user_id, users$user_id)
u$age_cat = users$age_cat[m]
u$birth_control = users$birth_control[m]
rm(m)

agg = aggregate(tender_breasts ~ cycleday_m_D + birth_control + age_cat + kmean_group , u, sum)
agg_cycles = aggregate(n_cycles ~ cycleday_m_D + birth_control + age_cat , u, sum)

agg = merge(agg, agg_cycles, all = TRUE)
agg$perc_tender_breasts = agg$tender_breasts/agg$n_cycles

agg2 = aggregate(perc_tender_breasts ~ cycleday_m_D + birth_control + age_cat + kmean_group , u, mean)

g = ggplot(agg[(!agg$age_cat %in% par$age_cat_exclude),], aes(x = cycleday_m_D, y = perc_tender_breasts, col = kmean_group))+
  geom_line()+facet_grid(age_cat ~ birth_control)+
  scale_x_continuous(breaks = par$x.axis)+
  scale_y_continuous(labels = scales::percent)+
  scale_color_manual(values = cols$clusters)+
  xlab("cycleday from 1st day of menstruation") + ylab("n tender breasts / n cycles")+
  guides(col = FALSE)
g


g = ggplot(agg[(!agg$age_cat %in% par$age_cat_exclude) & !((agg$age_cat == "(35,40]") & (agg$birth_control == "pill")),], 
           aes(x = cycleday_m_D, y = perc_tender_breasts, col = age_cat))+
  geom_line()+facet_grid(kmean_group ~ birth_control)+
  scale_x_continuous(breaks = par$x.axis)+
  scale_y_continuous(labels = scales::percent)+
  scale_color_manual(values = cols$age_cat)+
  xlab("cycleday from 1st day of menstruation") + ylab("n tender breasts / n cycles")
g


g = ggplot(agg2, aes(x = cycleday_m_D, y = perc_tender_breasts, col = kmean_group))+
  geom_line()+facet_grid(age_cat ~ birth_control)+
  scale_x_continuous(breaks = par$x.axis)+
  scale_y_continuous(labels = scales::percent)+
  scale_color_manual(values = cols$clusters)+
  xlab("cycleday from 1st day of menstruation") + ylab("n tender breasts / n cycles")+
  guides(col = FALSE)
g

rm(g)

```



```{r user_clustering saving user clustering results}
save(users, file = paste0(IO$Rdata, "users_with_clust.Rdata"))
```



### Playing aroung with PCA and distance to centroids

Just having a quick look at the PCA


```{r user_clustering PCA test}

PCA_users_tmp = prcomp(u_wide[,-1])
plot(PCA_users_tmp)

PCA_users = data.frame(user_id = u_wide$user_id, PC1 = as.numeric(PCA_users_tmp$x[,1]) , PC2 = as.numeric(PCA_users_tmp$x[,2]))
m = match(PCA_users$user_id, users$user_id)
PCA_users$user_cluser = users$user_cluster[m]
PCA_users$kmean_group = users$kmean_group[m]
PCA_users$TB_intensity = users$TB_intensity[m]
PCA_users$dist_u_clusters = users$dist_u_clusters[m]



ggplot(PCA_users, aes(x = PC1,y = PC2)) + geom_point(size = 0.01, alpha = 0.1)+ theme(aspect.ratio=PCA_users_tmp$sdev[2]/PCA_users_tmp$sdev[1])

ggplot(PCA_users, aes(x = PC1,y = PC2, col = kmean_group )) + geom_point(size = 0.01, alpha = 0.1)+ theme(aspect.ratio=PCA_users_tmp$sdev[2]/PCA_users_tmp$sdev[1])

ggplot(PCA_users, aes(x = PC1,y = PC2, col = kmean_group, size = TB_intensity)) + geom_point(alpha = 0.1) + scale_size("point", range = c(0,1/2)) + theme(aspect.ratio=PCA_users_tmp$sdev[2]/PCA_users_tmp$sdev[1])


ggplot(PCA_users, aes(x = PC1,y = PC2, col = user_cluser )) + geom_point(size = 0.1, alpha = 0.2)+ theme(aspect.ratio=PCA_users_tmp$sdev[2]/PCA_users_tmp$sdev[1])

rm(PCA_users, PCA_users_tmp)

```


And now, playing with the correlation and "distance to the cluster centroids"


```{r user_clustering playing with distance to cluster centroids}


usr = users[,c("user_id","kmean_group","user_cluster","TB_intensity","cor_M","cor_preM","dist_u_clusters")]
usr$d = 1-cor(c_M, c_preM)

usr$d1 = 1-usr$cor_preM
usr$d2 = 1-usr$cor_M

usr$D = usr$d^2
usr$D1 = usr$d1^2
usr$D2 = usr$d2^2
usr$s = (usr$d + usr$d1 + usr$d2)/2

usr$x = (usr$d^2 + usr$d1^2 - usr$d2^2 )/(2*usr$d)
usr$y = sqrt((usr$D*usr$D1 + usr$D*usr$D2 + usr$D1*usr$D2 - usr$D^2- usr$D1^2- usr$D2^2)/2)/usr$D
usr$y = 2/usr$d * sqrt(usr$s * (usr$s - usr$d)* (usr$s - usr$d1)*(usr$s - usr$d2))


ggplot(usr, aes(x = x, y = y, col = kmean_group)) + geom_point(size = 0.1, alpha = 0.1)
ggplot(usr, aes(x = x, y = y, col = kmean_group)) + geom_point(size = 0.1, alpha = 0.1) + xlim(c(-1,1.6)) + ylim(c(0,0.5))
ggplot(usr, aes(x = x, y = y)) + geom_point(size = 0.1, alpha = 0.2) + xlim(c(-1,1.6)) + ylim(c(0,0.5))
ggplot(usr, aes(x = x, y = y, size = TB_intensity)) + geom_point( alpha = 0.005) + xlim(c(-1,1.6)) + ylim(c(0,0.5))
ggplot(usr, aes(x = x, y = y, size = TB_intensity, col = kmean_group)) + geom_point( alpha = 0.005) + xlim(c(-1,1.6)) + ylim(c(0,0.5))
ggplot(usr, aes(x = x, y = y, col = user_cluster)) + geom_point(size = 0.1, alpha = 0.1) 


rm(usr)

```



```{r user_clustering cleaning workspace}

rm(u_subset, d_subset, u, d, u_wide, d_wide, agg_clust, c.dict)

```


