---
title: "Cycle clustering with categorical data and custom_jaccard distance - Exploring ideal number of clusters"
author: "Laura Symul"
date: "12/10/2018"
output: html_document
---



```{r cycle_clustering_imputed_custom_jaccard_clara_expl librairies and stuff, include = FALSE, eval = TRUE}
source("Scripts/00_setup.R")
```



```{r cycle_clustering_imputed_custom_jaccard_clara_expl setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```


```{r cycle_clustering_imputed_custom_jaccard_clara_expl functions jaccard-like-distance}
source("Scripts/00_functions_jaccard_like_distance.R")
```




##  CYCLES CLUSTERING IMPUTED DATA AND CUSTOM_JACCARD DISTANCE (clara)


### Loading imputed data


```{r cycle_clustering_imputed_custom_jaccard_clara_expl load days_TB_only, eval = TRUE}
load(file = paste0(IO$tmp_Rdata,"days_TB_only.Rdata"), verbose = TRUE)
days_TB = days
rm(days)
```

```{r cycle_clustering_imputed_custom_jaccard_clara_expl loading d_wide with cat data, eval = TRUE}

load(file = paste0(IO$tmp_Rdata,"d_wide_imputed.Rdata"), verbose = TRUE)

```

```{r cycle_clustering_imputed_custom_jaccard_clara_expl create d_imputed as d_wide with imputed data in long format, eval = FALSE}
d_wide_tmp = d_wide
colnames(d_wide_tmp)[2:ncol(d_wide)] = paste0("tender_breasts.",1:(ncol(d_wide)-1))
d_imputed = reshape(d_wide_tmp, varying = list(2:ncol(d_wide_tmp)) , idvar = "cycle_id_m", direction = "long")
rm(d_wide_tmp)
d_imputed$time = d_imputed$time - 19
colnames(d_imputed) = c("cycle_id_m","cycleday_m_D","tender_breasts")


d_imputed$cycle_id_m_f = d_imputed$cycle_id_m
d_imputed$cycle_id_m = as.character(d_imputed$cycle_id_m)
user_and_cycle_nb = strsplit(x = d_imputed$cycle_id_m , split = "_")
d_imputed$user_id = unlist(user_and_cycle_nb)[ c(TRUE,FALSE) ]
d_imputed$cycle_nb_m = as.numeric(unlist(user_and_cycle_nb)[ c(FALSE, TRUE) ])

rm(user_and_cycle_nb)

save(d_imputed, file = paste0(IO$tmp_Rdata, "d_imputed.Rdata"))
```



```{r cycle_clustering_imputed_custom_jaccard_clara_expl load d_imputed, eval = TRUE, cache = FALSE}
load(file = paste0(IO$tmp_Rdata, "d_imputed.Rdata"), verbose = TRUE)
```



### Using clara with CUSTOM_JACCARD distance and weight on the cycledays


```{r cycle_clustering_imputed_custom_jaccard_clara_expl weight for distance evaluation, eval = TRUE, fig.height=3, fig.width=7}

load(file = paste0(IO$out_Rdata, "weight_for_distance.Rdata"), verbose = TRUE)
w = ww$w

ggplot(ww, aes(x = cycleday_m_D, y = w)) + geom_point() + geom_line() + scale_x_continuous(breaks = par$x.axis)+ ylim(c(0,1))
```

```{r cycle_clustering_imputed_custom_jaccard_clara_expl prep}
d = days_TB[!is.na(days_TB$cycleday_m_D),]
d$tender_breasts = 1
```


#### Checking distance implementation in CLARA function.

First, we check that we correctly implemented the distance in the CLARA function by testing it against another function used to compute the distance.


```{r cycle_clustering_imputed_custom_jaccard_clara_expl comparison with the Rccp manually writen distance}

clara_n = clara(d_wide[1:10,-1], k = 2, metric = "custom_jaccard", w = w, cjratio = r)
clara_n$diss

jaccard_dist = new_jaccard(d_wide[1:10,-1], r = r, w = w)
jaccard_dist

all(round(as.matrix(clara_n$diss), digits = 4) == round(jaccard_dist, digits = 4))

```




#### Exploring the ideal number of clusters.


```{r cycle_clustering_imputed_custom_jaccard_clara_expl exploring number of clusters with clara, fig.width= 10, fig.height= 4, cache = FALSE, eval = TRUE}
cycle_ids = unique(d$cycle_id_m)
n_centers = 2:7
df = data.frame()
tic()
for(r in c(0,0.5,0.6,0.7,0.75,0.8,0.9,1)){
  cat(r,"\n")
  for(n_center in n_centers){
    cat("\t",n_center,"\n")
    
    clara_n = clara(d_wide[,-1], k = n_center, metric = "custom_jaccard", w = w, cjratio = r)
    
    cat("\t\t",clara_n$silinfo$avg.width,"\n")
    df = rbind(df,data.frame(n_clust = n_center, r = r, avg_silhouette_score = clara_n$silinfo$avg.width))
    
    silh = as.data.frame(clara_n$silinfo$widths)
    silh$x = 1:nrow(silh)
    silh$rows = as.numeric(rownames(silh))
    
    d$cluster_num = clara_n$clustering[match(d$cycle_id_m, d_wide$cycle_id_m)]
    d_imputed$cluster_num = clara_n$clustering[match(d_imputed$cycle_id_m, d_wide$cycle_id_m)]
    
    
    # show the samples chosen by clara FOR SILHOUETTE
    m = match(silh$rows, rownames(d_wide))
    cycle_ids_silh = as.character(d_wide$cycle_id_m[m])
    m = which(!is.na(match( d_imputed$cycle_id_m, cycle_ids_silh)))
    d_subset = d_imputed[m,]
    d_subset = d_subset[order(d_subset$cluster_num),]
    d_subset$cycle_id_m = factor(d_subset$cycle_id_m, levels = rev(cycle_ids_silh))
    g_samples = ggplot_imputed_TB(d_subset, facet_grid = FALSE)+scale_size(range = c(2,2)) + ggtitle(paste0("r = ",r))
    
    g_silh = ggplot(silh, aes(fill = factor(cluster),x = factor(x, levels =rev(x)), y = sil_width)) + coord_flip()+
      geom_bar(stat = "identity")+
      geom_point(aes( col = factor(neighbor),y = pmax(0,sil_width) + 0.025), size = 3)+
      #ylim(c(-1,1))+
      geom_hline(yintercept = clara_n$silinfo$avg.width, linetype = 2)+ 
      ggtitle(paste0("avg. silh score = ",round(clara_n$silinfo$avg.width,digits = 3)))+
      guides(fill = FALSE, color = FALSE)+
      xlab("")+ylab("silh width")+ theme(axis.text.y = element_blank())
    
    
    mds = data.frame(cmdscale(d = clara_n$diss, k = 2))
    colnames(mds) = c("x","y")
    mds$cluster_num = as.factor(clara_n$clustering[match(rownames(mds), names(clara_n$clustering))])
    m = match( silh$rows, rownames(mds))
    mds = mds[m,]
    mds$num = 1:nrow(mds)
    g_mds = ggplot(mds, aes(x = x, y = y, col = cluster_num)) + coord_fixed()+
      geom_point(size = 4, alpha = 0.5) + 
      geom_text(label = 1:nrow(mds))+
      guides(color = FALSE)+ggtitle("MDS")+xlab("")+ylab("")
    
    grid.arrange(g_samples, g_silh, g_mds, nrow = 1, widths = c(2,1,2.2))
  }
}
toc()

save(df, file = paste0(IO$tmp_Rdata,"silhouette_score_summary.Rdata"))

rm(d_subset, n_center, n_centers)
```



```{r cycle_clustering_imputed_custom_jaccard_clara_expl silhouette summary}

df$n_clusters = factor(df$n_clust)
ggplot(df, aes(x = n_clusters, y = avg_silhouette_score, fill = avg_silhouette_score)) + geom_bar(stat = "identity")+ facet_grid(r ~ .)

```





