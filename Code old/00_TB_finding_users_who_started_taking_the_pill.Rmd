---
title: "Finding users who started to take the pill"
author: "Laura Symul"
date: "11/3/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache  = TRUE)
```



```{r librairies and stuff, include = FALSE, eval = TRUE}
source("00_variables.R")
source("00_libraries.R")
```


```{r parameters, include=FALSE}
par = list()
par$reset = FALSE
par$N.files = 6
```



# Loading data

We take all logs from users that
- are on "none" or "condoms" as birth control method (on-boarding data)
- have at least one log in the "pill_hbc" category

```{r loading data}


days.file = paste0(IO$Rdata,"days_users_who_started_to_take_the_pill.Rdata")

if((!file.exists(days.file)) | par$reset){
  
  clue.file.list = list.files(paste0(IO$Rdata,"days/"))
  clue.file.list = paste0(paste0(IO$Rdata,"days/"),clue.file.list)
  #clue.file.list = clue.file.list[1:par$N.files]
  
  days_bc_change = data.frame()
  tic()
  for(file in clue.file.list){
    cat(file,"\n")
    load(file, verbose = TRUE)
    users.keep = unique(
      days$user_id[ (days$birth_control == "none / condoms") & 
                           (days$category== "pill_hbc")
                         ])
    m = match(days$user_id, users.keep)
    days =  days[which(!is.na(m)), ]
    days_bc_change = rbind(days_bc_change,days)
    #cat(dim(days),"\n")
  }
  toc()
  rm(users.keep, file, clue.file.list, days)
  save(days_bc_change,file = days.file)
}else{cat("loading file\n");load(file = days.file)}
rm(days.file)

```


# Looking at some examples

```{r plot a few examples}
set.seed(1)
user_ids = unique(days_bc_change$user_id)[sample(1:1000, 20)]
for(user_id in user_ids){
  k = which((days_bc_change$user_id == user_id) &
              days_bc_change$category %in% c("pill_hbc", "period","pain","emotion"))
  
  days_this_user = days_bc_change[k,]
  g = ggplot(days_this_user, aes(x = date, y = type, col = category)) + geom_point()
  g = g + geom_vline(xintercept = days_this_user$date[days_this_user$cycleday == 1])
  print(g)
}
rm(user_ids, g)

```

So, we can already see that we need to add some conditions:

- at least 4 cycles with tracking before starting taking the pill
- at least 4 cycles with tracking and taking the pill (feature == "taken") (does not have to be tracked everyday but at least 10 times in the cycle).
- cycles are ~ 28 days when taking the pill and less than 50 days before taking the pill.


# Selecting cycles of users that show a clear "no pill" > "pill" transition

We first build a list of all cycles from all users.

```{r preparing for conditions on the taking the pill transition}

cycles_bc_change = data.frame(cycle_id = unique(days_bc_change$cycle_id),stringsAsFactors = FALSE)

days_bc_change$n_taken = 1
agg = aggregate(n_taken ~ cycle_id, days_bc_change[days_bc_change$type == "taken",], sum)

cycles_bc_change = merge(cycles_bc_change, agg, all = TRUE)
cycles_bc_change$n_taken[is.na(cycles_bc_change$n_taken)] = 0

m = match(cycles_bc_change$cycle_id, days_bc_change$cycle_id)
cycles_bc_change$user_id = days_bc_change$user_id[m]
cycles_bc_change$cycle_nb = days_bc_change$cycle_nb[m]
cycles_bc_change$cycle_length = days_bc_change$cycle_length[m]

o = order(cycles_bc_change$user_id, cycles_bc_change$cycle_nb)
cycles_bc_change = cycles_bc_change[o, c("user_id","cycle_id","cycle_nb", "cycle_length","n_taken")]

rm(m, agg,o )
```



```{r conditions on the taking the pill transition}

### at least 4 cycles without taking the pill and with cycles that are shorter than 50 days
cycles_bc_change$n_taken_cumsum = ave(cycles_bc_change$n_taken,cycles_bc_change$user_id, FUN = cumsum)
# removing any cycle before a >50 days cycle
agg = aggregate(cycle_nb ~ user_id, cycles_bc_change[(cycles_bc_change$n_taken_cumsum == 0) & (cycles_bc_change$cycle_length > 50),], max)
colnames(agg) = c("user_id","min_cycle_nb") 
cycles_bc_change = merge(cycles_bc_change, agg, by = "user_id", all = TRUE)
o = order(cycles_bc_change$user_id, cycles_bc_change$cycle_nb)
cycles_bc_change = cycles_bc_change[o,]
cycles_bc_change$min_cycle_nb[is.na(cycles_bc_change$min_cycle_nb)] = 0
j = which((cycles_bc_change$n_taken_cumsum == 0) & (cycles_bc_change$cycle_nb <= cycles_bc_change$min_cycle_nb))
cycles_bc_change = cycles_bc_change[-j,]
rm(o,j)

# keeping users that have at least 4 cycles without the pill
users_bc_change = aggregate(cycle_id ~ user_id, cycles_bc_change[cycles_bc_change$n_taken_cumsum == 0,], length)
colnames(users_bc_change) = c("user_id","n_cycles_without_pill_at_start")
users_bc_change$ok_no_pill = (users_bc_change$n_cycles_without_pill_at_start >=4)

m = match(cycles_bc_change$user_id, users_bc_change$user_id[which(users_bc_change$ok_no_pill)])
cycles_bc_change$ok_no_pill = !is.na(m) & (cycles_bc_change$n_taken_cumsum == 0)

cycles_bc_change =  cycles_bc_change[!is.na(m),]
cycles_bc_change = cycles_bc_change[, -which(colnames(cycles_bc_change) %in% c("n_taken_cumsum","min_cycle_nb"))]

## at least 4 cycles of taking the pill (at least 10 logs) after these initial cycles without the pill and pill cycles within 18-35 days

cycles_bc_change$at_least_10_taken = (cycles_bc_change$n_taken >= 10)
cycles_bc_change$length_ok = (cycles_bc_change$cycle_length %in% 18:35)


cycles_bc_change_tmp = cycles_bc_change[!cycles_bc_change$ok_no_pill,]
cycles_bc_change_tmp$pill_ok_cumsum = ave(
  !(cycles_bc_change_tmp$at_least_10_taken & cycles_bc_change_tmp$length_ok),
  cycles_bc_change_tmp$user_id, 
  FUN = cumsum)

agg = aggregate(cycle_id ~ user_id, cycles_bc_change_tmp[cycles_bc_change_tmp$pill_ok_cumsum == 0,], length)
agg$at_least_4_cycle_with_10_pill_after_start = (agg$cycle_id >=4)

m = match(cycles_bc_change_tmp$user_id, agg$user_id[which(agg$at_least_4_cycle_with_10_pill_after_start)])
cycles_bc_change_tmp$at_least_4_cycle_with_10_pill_after_start = !is.na(m) & (cycles_bc_change_tmp$pill_ok_cumsum == 0)

m = match(cycles_bc_change$cycle_id, cycles_bc_change_tmp$cycle_id[cycles_bc_change_tmp$at_least_4_cycle_with_10_pill_after_start])

cycles_bc_change$ok_pill = !is.na(m)

cycles_bc_change = cycles_bc_change[, -which(colnames(cycles_bc_change) %in% c("at_least_10_taken","length_ok"))]


# keeping users that have at least one "ok_no_pill" and one "ok_pill"
user_ids = intersect(unique(cycles_bc_change$user_id[cycles_bc_change$ok_no_pill]),unique(cycles_bc_change$user_id[cycles_bc_change$ok_pill]) )
m = match(cycles_bc_change$user_id, user_ids)
cycles_bc_change = cycles_bc_change[!is.na(m),]

# keeping cycles that are ok for the analysis of no_pill > pill transition
cycles_bc_change$ok_pill_transition = cycles_bc_change$ok_no_pill | cycles_bc_change$ok_pill
cycles_bc_change$pill_status = NA
cycles_bc_change$pill_status[cycles_bc_change$ok_no_pill] = "before_the_pill"
cycles_bc_change$pill_status[cycles_bc_change$ok_pill] = "on_the_pill"

cycles_bc_change = cycles_bc_change[cycles_bc_change$ok_pill_transition,]
```



# Saving the data for the main analysis of breast tenderness

```{r save cycles_bc_change for the main analysis}
cycles_bc_change_back_up = cycles_bc_change
cycles_bc_change = cycles_bc_change[,c("user_id","cycle_id","cycle_nb","cycle_length","n_taken","pill_status")]
save(cycles_bc_change, file = paste0(IO$Rdata,"cycles_bc_change.Rdata"))
```



I think this is not necessary anymore

```{r saving the "days" of these selected users, eval = FALSE}
m = match(days_bc_change$user_id, unique(cycles_bc_change$user_id))

days_bc_change_all = days_bc_change
days_bc_change = days_bc_change[(!is.na(m)) & (days_bc_change$category %in% c("pill_hbc","emotion") ),]
save(days_bc_change, file = paste0(IO$Rdata,"days_bc_change.Rdata"))
```





